<%INIT>
  use Authen::Bitcard;
  my $bc = Authen::Bitcard->new;
  die 'No Bitcard auth token provided as $BitcardToken in the RT configuration file on this server.'
        unless $RT::BitcardToken;
  $bc->token($RT::BitcardToken);

  my $user = $bc->verify(\%ARGS);

  ### changing the 'defined $user->{'email}' line back to '$user' enables the
  ### fsck.com #7277 exploit, if you've saved the 'Manage your Bitcard account'
  ### URL from a previous successful Bitcard login.

  # if the user isn't logged in and we got credentials from Bitcard, load the user
  if ( (! $session{'CurrentUser'}) && (defined $user->{'email'}) ) {

      # set a global user so we know elsewhere we're using Bitcard for auth
      $session{'BitcardUser'} = $user;

      # Bitcard has verified that the user has control of this e-mail address,
      # so it's okay to use it to get a valid RT user

      # we've got a valid user, so try to load
      $session{'CurrentUser'} = RT::CurrentUser->new();
      $session{'CurrentUser'}->LoadByEmail( $user->{'email'} );
      if ( not $session{'CurrentUser'}->id ) {
          my $UserObj = RT::User->new($RT::SystemUser);
          my ($id, $msg) 
              = $UserObj->Create(
                                  Name => $user->{'username'},
                                  RealName => $user->{'name'},
                                  EmailAddress => $user->{'email'},
                                  Privileged => 1,
                                );
          if ( $UserObj->id ) {
              # created the user, now load them as the current user
              $session{'CurrentUser'}->Load($UserObj->id);

              # redirect the user to their preference page to add more info
              $m->redirect($RT::WebPath . '/User/Prefs.html');
          }
          else {
              # we couldn't create the user.  abort abort abort!
              delete $session{'CurrentUser'};
              delete $session{'BitcardUser'};
              my $qs = $m->comp('/Elements/QueryString',
                                 Error => loc("Cannot create user: [_1]", $msg));
              $m->redirect($RT::WebPath . '/?' . $qs);
              $m->abort();
          }
      }
  } 
</%INIT>
